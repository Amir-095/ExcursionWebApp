<!DOCTYPE html>
{% load static %}
{% load i18n %}
<html>
<head>
    <title>{{ excursion.title }}</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="{% static 'css/fonts.css' %}" />
    <link rel="stylesheet" href="{% static 'css/excursion_detail.css' %}" />
    <link rel="stylesheet" href="{% static 'css/modal.css' %}" />
    <link rel="stylesheet" href="{% static 'css/notifications.css' %}" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/ru.js"></script>
</head>
<body>
    <!-- Контейнер для toast-уведомлений -->
    <div class="toast-container" id="toastContainer"></div>
    
    {% include 'navbar.html' %}
    
    <div class="excursion-detail-container">
    <h1>{{ excursion.title }}</h1>
        <div class="excursion-detail-header">
                <img src="{{ excursion.image_url }}" alt="{{ excursion.title }}">
        </div>

        <div class="excursion-detail-content">
            <div class="excursion-info">
                <div class="info-item">
                    <img src="{% static 'images/Clock.png' %}" alt="Clock" class="info-icon">
                    <div class="info-text">
                        <span class="label">{% trans "Продолжительность:" %}</span>
                    <span class="value">
                        {% if excursion.duration == 'Несколько дней' and excursion.number_of_days %}
                            {{ excursion.number_of_days }} {% if excursion.number_of_days == 1 %}день{% elif excursion.number_of_days < 5 %}дня{% else %}дней{% endif %} ({{ excursion.start_time|time:"H:i" }})
                        {% elif excursion.duration == '1 день' %}
                            1 день ({{ excursion.start_time|time:"H:i" }} - {{ excursion.end_time|time:"H:i" }})
                        {% elif excursion.duration == 'Несколько часов' %}
                            {{ excursion.start_time|time:"H:i" }} - {{ excursion.end_time|time:"H:i" }}
                        {% else %}
                            {{ excursion.start_time|time:"H:i" }} - {{ excursion.end_time|time:"H:i" }} {# Fallback на всякий случай #}
                        {% endif %}
                    </span>
                    </div>
                </div>
                <div class="info-item">
                    <img src="{% static 'images/Two-user.png' %}" alt="Group" class="info-icon">
                    <div class="info-text">
                        <span class="label">                                    
                                    {% if excursion.group_type == 'Групповые' %}
                                        {% trans "Групповые" %}
                                    {% elif excursion.group_type == 'Индивидуальные' %}
                                        {% trans "Индивидуальные" %}
                                    {% elif excursion.group_type == 'Семейные' %}
                                        {% trans "Семейные" %}
                                    {% else %}
                                        {{ excursion.group_type }}  {# Если значение не соответствует ни одному из вариантов #}
                                    {% endif %}
                        </span>
                        <span class="value">{% trans excursion.people_count_range %}</span>
                    </div>
                </div>
                <div class="info-item">
                    <img src="{% static 'images/ic_language_48px.png' %}" alt="Language" class="info-icon">
                    <div class="info-text">
                        <span class="label">{% trans "Язык:" %}</span>
                                <span class="value price">
                                    {% if excursion.language == 'Казахский' %}
                                        {% trans "Казахский" %}
                                    {% elif excursion.language == 'Русский' %}
                                        {% trans "Русский" %}
                                    {% elif excursion.language == 'Английский' %}
                                        {% trans "Английский" %}
                                    {% else %}
                                        {{ excursion.language }}
                                    {% endif %}
                                </span>
                    </div>
                </div>
            </div>
            <hr>
            <div class="description-guide-container">
                <div class="excursion-description">
                    <p>{{ translated_description|default:excursion.description }}</p>
                </div>

                <div class="guide-info">
                    <div class="guide-header">
                        <div class="guide-details">
                            <h3>{% trans "Гид" %}</h3>
                            <img src="{% static 'images/guideprofile.png' %}" alt="Гид" class="guide-avatar">
                            <p class="guide-name">{{ excursion.guide_name }}</p>
                        </div>
                    </div>
                </div>
            </div>
            <hr>
            <div class="lists-container">
                {% if included_items %}
                    <div class="list-column">
                        <h3>{% trans "Что включено" %}</h3>
                        <ul class="included-list">
                            {% for item in included_items %}
                                <li>
                                    <img src="{% static 'images/check-circle.png' %}" alt="✔" class="list-icon">
                                    {% if item == 'Услуги гида/водителя' %}
                                        {% trans "Услуги гида/водителя" %}
                                    {% elif item == 'Трансфер на протяжении всего пути' %}
                                        {% trans "Трансфер на протяжении всего пути" %}
                                    {% elif item == 'Групповая аптечка' %}
                                        {% trans "Групповая аптечка" %}
                                    {% elif item == 'Включенный обед' %}
                                        {% trans "Включенный обед" %}
                                    {% elif item == 'Питание' %}
                                        {% trans "Питание" %}
                                    {% else %}
                                        {{ item }}
                                    {% endif %}
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                {% endif %}

                {% if not_included_items %}
                    <div class="list-column">
                        <h3>{% trans "Что не включено" %}</h3>
                        <ul class="not-included-list">
                            {% for item in not_included_items %}
                                <li>
                                    <img src="{% static 'images/close-circle.png' %}" alt="✘" class="list-icon">
                                    {% if item == 'Услуги гида/водителя' %}
                                        {% trans "Услуги гида/водителя" %}
                                    {% elif item == 'Трансфер на протяжении всего пути' %}
                                        {% trans "Трансфер на протяжении всего пути" %}
                                    {% elif item == 'Групповая аптечка' %}
                                        {% trans "Групповая аптечка" %}
                                    {% elif item == 'Включенный обед' %}
                                        {% trans "Включенный обед" %}
                                    {% elif item == 'Питание' %}
                                        {% trans "Питание" %}
                                    {% else %}
                                        {{ item }}
                                    {% endif %}
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                {% endif %}
            </div>
            <hr>
            {% if excursion.program %}
            <div class="program-container">
                <h3>{% trans "Программа" %}</h3>
                <div class="program-content">
                    {{ translated_program|default:excursion.program|linebreaks }}
                </div>
            </div>
            <hr>
            {% endif %}
            <h3>{% trans "Доступные даты" %}</h3>
            
            <!-- Новый контейнер для двух колонок -->
            <div class="booking-details-container">
                <!-- Левая колонка с бронированием -->
                <div class="booking-column">
                    <div class="booking-card">
                        <h2 class="booking-title">{% trans "Выберите дату и время" %}</h2>
                        
                        <div class="date-selector">
                            {% if dates %}
                                <!-- Показываем только две первые даты -->
                                {% for date in dates|slice:":2" %}
                                    <div class="date-option {% if forloop.first %}active{% endif %}" onclick="selectDate('{{ date }}')">
                                        <div class="date-label">{% if forloop.first %}{% trans "Завтра" %}{% elif forloop.counter == 2 %}{% trans "Послезавтра"%}{% endif %}</div>
                                        <div class="date-value">{{ date }}</div>
                                    </div>
                                {% endfor %}

                                <!-- Кнопка для открытия календаря с остальными датами -->
                                <div class="date-option date-picker" id="datepicker-btn">
                                    <img src="{% static 'images/calendar-search.png' %}" alt="Календарь" class="calendar-icon">
                                    <div class="date-value">{% trans "Выбрать дату" %}</div>
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Hidden input to track the selected date -->
                        <input type="hidden" id="selectedDate" name="selectedDate" value="{{ dates.0 }}" />
                        
                        <div class="divider"></div>
                        
                        <div class="ticket-row">
                            <div class="ticket-info">
                                <div class="ticket-type">{% trans "Стандартный билет" %}</div>
                            </div>
                            <div class="ticket-price" data-price="{{ excursion.price }}">₸ {{ excursion.price }}</div>
                            <div class="ticket-counter">
                                <button class="counter-btn decrease" onclick="updateTicketCount(-1)">−</button>
                                <input type="number" id="ticketCount" value="1" min="1" onchange="updateTotalPrice()" readonly>
                                <button class="counter-btn increase" onclick="updateTicketCount(1)">+</button>
                            </div>
                        </div>
                        
                        <button class="booking-btn" onclick="checkAuthAndProceed(() => redirectToPayment({{ excursion.id }}))">
                            {% trans "Начать бронирование" %}
                        </button>
                    </div>
                </div>
                
                <!-- Правая колонка с деталями экскурсии -->
                <div class="details-column">
                    <div class="details-card">
                        <h2 class="details-title">{% trans "Детали экскурсии" %}</h2>
                        
                        <div class="organizer-info">
                            <div class="organizer-avatar">
                                <img src="{% static 'images/guideprofile.png' %}" alt="Организатор" class="avatar-img">
                            </div>
                            <div class="organizer-details">
                                <div class="organizer-name">{{ excursion.guide_name }}</div>
                                <div class="organizer-role">{% trans "Организатор" %}</div>
                            </div>
                        </div>
                        
                        <div class="excursion-details-list">
                            <div class="detail-item">
                                <div class="detail-label">{% trans "Тип экскурсии:" %}</div>
                                <div class="detail-value">
                                    {% if excursion.group_type == 'Групповые' %}
                                        {% trans "Групповые" %}
                                    {% elif excursion.group_type == 'Индивидуальные' %}
                                        {% trans "Индивидуальные" %}
                                    {% elif excursion.group_type == 'Семейные' %}
                                        {% trans "Семейные" %}
                                    {% else %}
                                        {{ excursion.group_type }}  {# Если значение не соответствует ни одному из вариантов #}
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="detail-item">
                                <div class="detail-label">{% trans "Время начала:" %}</div>
                                <div class="detail-value" id="excursion-start-date" 
                                     data-start-time="{{ excursion.start_time|time:'H:i' }}"
                                     data-iso-date="{{ default_date|default:dates.0 }}">
                                    {{ default_date|default:dates.0 }} в {{ excursion.start_time|time:"H:i" }}
                                </div>
                                <input type="hidden" id="selectedDate" name="selectedDate" value="{{ default_date|default:dates.0 }}" />
                            </div>
                            
                            <div class="detail-item">
                                <div class="detail-label">{% trans "Длительность:" %}</div>
                                <div class="detail-value">
                                    {% if excursion.duration == 'Несколько дней' and excursion.number_of_days %}
                                        {{ excursion.number_of_days }} {% if excursion.number_of_days == 1 %}день{% elif excursion.number_of_days < 5 %}дня{% else %}дней{% endif %} ({{ excursion.start_time|time:"H:i" }})
                                    {% elif excursion.duration == '1 день' %}
                                        1 день ({{ excursion.start_time|time:"H:i" }} - {{ excursion.end_time|time:"H:i" }})
                                    {% else %}
                                        {{ excursion.start_time|time:"H:i" }} - {{ excursion.end_time|time:"H:i" }}
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="detail-item">
                            {% if excursion.meeting_address %}
                                <div class="detail-label">{% trans "Место встречи:" %}</div>
                                <div class="detail-value">{{ excursion.meeting_address }}</div>
                            {% endif %}
                            </div>
                            
                            <div class="detail-item">
                                <div class="detail-label">{% trans "Место окончания:" %}</div>
                                <div class="detail-value">
                                    {% if excursion.end_location %}
                                        {{ excursion.end_location }}
                                    {% else %}
                                        {{ excursion.location }}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                            {% if excursion.meeting_address %}
                                <div class="google-map">
                                    <!-- API ключ передаётся из контекста в шаблон -->
                                    <iframe
                                        width="100%"
                                        height="250"
                                        frameborder="0" style="border:0"
                                        src="https://www.google.com/maps/embed/v1/place?key={{ google_maps_api_key }}&q={{ excursion.meeting_address|urlencode }}"
                                        allowfullscreen>
                                    </iframe>
                                </div>
                            {% else %}
                                <a href="https://www.google.com/maps/search/?api=1&query={{ excursion.location|urlencode }}" class="map-link" target="_blank">Google карта</a>
                            {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% include 'modal.html' %}
    {% include 'feedback.html' %}
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ru.js"></script>
    <script src="{% static 'js/excursion_detail.js' %}"></script>
    {% include 'js_constants.html' %}
    <!-- Скрытое поле с доступными датами -->
    <div id="availableDatesData" style="display: none;" 
         data-dates="{% for date in dates %}{{ date }}{% if not forloop.last %},{% endif %}{% endfor %}">
    </div>
    <script>
        window.CURRENT_LANG = "{{ current_language }}";
        window.LABELS = {
            tomorrow: "{% trans 'Завтра' %}",
            dayAfterTomorrow: "{% trans 'Послезавтра' %}",
            availableDate: "{% trans 'Доступная дата' %}"
        };
    </script>
</body>
</html> 